<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>SparkPoint</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.7.0/dist/ethers.umd.min.js"></script>
    <style>
        body { background: #000; color: #fff; font-family: sans-serif; text-align: center; padding: 50px 20px; }
        .box { border: 1px solid #333; padding: 30px; border-radius: 20px; background: #111; max-width: 400px; margin: auto; }
        button { background: #f39c12; color: #000; border: none; padding: 15px; width: 100%; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 16px; }
        #status { margin-top: 20px; color: #aaa; font-size: 14px; }
        #refBox { display: none; margin-top: 20px; background: #222; padding: 10px; border-radius: 10px; word-break: break-all; }
    </style>
</head>
<body>

<div class="box">
    <h1>SparkPoint</h1>
    <p>Вход: 0.05 BNB</p>
    <button id="btn" onclick="connect()">Подключить кошелек</button>
    <div id="status">Нажмите кнопку</div>
    
    <div id="refBox">
        <p style="color: #f39c12">Твоя ссылка для 2 участников:</p>
        <small id="linkText"></small>
    </div>
</div>

<script>
    const contractAddr = "0x137cbBBb38962ABd3A3a0D212C1f408FBD92ffb8";
    const abi = [
        "function register(address _ref) external payable",
        "function users(address) view returns (uint256, address, uint256, uint256, uint256, bool)"
    ];

    let signer, contract;
    const refFromUrl = new URLSearchParams(window.location.search).get('ref') || "0x0000000000000000000000000000000000000000";

    async function connect() {
        if (!window.ethereum) {
            alert("Используйте браузер Trust Wallet или MetaMask");
            return;
        }

        try {
            const provider = new ethers.BrowserProvider(window.ethereum);
            const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
            signer = await provider.getSigner();
            contract = new ethers.Contract(contractAddr, abi, signer);
            
            const userAddr = accounts[0];
            document.getElementById('status').innerText = "Адрес: " + userAddr.substring(0,6) + "...";
            
            // Проверяем регистрацию
            const user = await contract.users(userAddr);
            const exists = user[5]; // 6-й параметр в структуре User - bool exists

            if (exists) {
                showRef(userAddr);
            } else {
                document.getElementById('btn').innerText = "Оплатить 0.05 BNB";
                document.getElementById('btn').onclick = register;
            }
        } catch (e) {
            document.getElementById('status').innerText = "Ошибка: " + e.message;
        }
    }

    async function register() {
        try {
            document.getElementById('status').innerText = "Ждем оплаты...";
            const tx = await contract.register(refFromUrl, {
                value: ethers.parseEther("0.05")
            });
            await tx.wait();
            location.reload(); // Перезагружаем чтобы показать ссылку
        } catch (e) {
            alert("Ошибка транзакции");
        }
    }

    function showRef(addr) {
        const link = window.location.origin + window.location.pathname + "?ref=" + addr;
        document.getElementById('linkText').innerText = link;
        document.getElementById('refBox').style.display = "block";
        document.getElementById('btn').innerText = "Вы уже в проекте";
        document.getElementById('btn').disabled = true;
    }
</script>

</body>
</html>
