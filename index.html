<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>SparkPoint TESTNET</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.7.0/dist/ethers.umd.min.js"></script>
    <style>
        body { background: #0b1015; color: #fff; font-family: sans-serif; text-align: center; padding: 40px 20px; }
        .box { border: 2px solid #e74c3c; padding: 25px; border-radius: 15px; background: #161b22; max-width: 380px; margin: auto; }
        button { background: #e74c3c; color: #fff; border: none; padding: 18px; width: 100%; border-radius: 12px; font-weight: bold; cursor: pointer; font-size: 16px; margin-top: 15px; }
        #status { margin-top: 20px; color: #f1c40f; font-size: 13px; min-height: 40px; }
        #refBox { display: none; margin-top: 20px; background: #0d1117; padding: 15px; border-radius: 10px; border: 1px dashed #e74c3c; }
        .testnet-label { background: #f1c40f; color: #000; padding: 2px 8px; border-radius: 5px; font-size: 10px; font-weight: bold; }
    </style>
</head>
<body>

<div class="box">
    <span class="testnet-label">BSC TESTNET MODE</span>
    <h2 style="margin-top:10px">SparkPoint</h2>
    <p>Цена входа: 0.05 T-BNB</p>
    
    <button id="btnConnect" onclick="connectAndCheck()">ПОДКЛЮЧИТЬ ТЕСТОВЫЙ КОШЕЛЕК</button>
    <button id="btnAction" style="display:none; background:#27ae60">ОПЛАТИТЬ (TESTNET)</button>
    
    <div id="status">Нажмите кнопку подключения</div>
    
    <div id="refBox">
        <p style="color: #e74c3c; font-size: 14px; margin: 0;">Ваша ссылка (Testnet):</p>
        <div id="linkText" style="font-size: 11px; color: #2ecc71; margin: 10px 0; word-break: break-all;"></div>
        <button onclick="copyLink()" style="padding: 10px; font-size: 12px; margin-top: 5px; background: #444;">Копировать</button>
    </div>
</div>

<script>
    const contractAddr = "0x137cbBBb38962ABd3A3a0D212C1f408FBD92ffb8";
    const testnetChainId = "0x61"; // BSC Testnet

    const abi = [
        "function register(address _ref) external payable",
        "function users(address) view returns (uint256, address, uint256, uint256, uint256, bool)"
    ];

    let signer, contract, userAddr;
    const urlParams = new URLSearchParams(window.location.search);
    const referrer = urlParams.get('ref') || "0x0000000000000000000000000000000000000000";

    async function switchNetwork() {
        try {
            await window.ethereum.request({
                method: 'wallet_switchEthereumChain',
                params: [{ chainId: testnetChainId }],
            });
        } catch (error) {
            if (error.code === 4902) {
                await window.ethereum.request({
                    method: 'wallet_addEthereumChain',
                    params: [{
                        chainId: testnetChainId,
                        chainName: 'BSC Testnet',
                        nativeCurrency: { name: 'tBNB', symbol: 'tBNB', decimals: 18 },
                        rpcUrls: ['https://data-seed-prebsc-1-s1.binance.org:8545/'],
                        blockExplorerUrls: ['https://testnet.bscscan.com/']
                    }]
                });
            }
        }
    }

    async function connectAndCheck() {
        if (!window.ethereum) {
            alert("Используйте браузер кошелька");
            return;
        }

        try {
            await switchNetwork();
            const provider = new ethers.BrowserProvider(window.ethereum);
            const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
            userAddr = accounts[0];
            signer = await provider.getSigner();
            contract = new ethers.Contract(contractAddr, abi, signer);

            document.getElementById('status').innerText = "Проверка в Testnet...";
            const userData = await contract.users(userAddr);
            const exists = userData[5];

            if (exists) {
                showRef(userAddr);
                document.getElementById('status').innerText = "Вы зарегистрированы в Testnet";
                document.getElementById('btnConnect').style.display = "none";
            } else {
                document.getElementById('status').innerText = "Сеть Testnet готова";
                document.getElementById('btnConnect').style.display = "none";
                document.getElementById('btnAction').style.display = "block";
                document.getElementById('btnAction').onclick = startPayment;
            }
        } catch (e) {
            console.error(e);
            document.getElementById('status').innerText = "Ошибка: контракт не найден в Testnet. Проверьте адрес.";
        }
    }

    async function startPayment() {
        try {
            document.getElementById('status').innerText = "Подтвердите тестовую оплату...";
            const tx = await contract.register(referrer, {
                value: ethers.parseEther("0.05")
            });
            await tx.wait();
            location.reload();
        } catch (e) {
            alert("Ошибка в Testnet. У вас есть тестовые BNB?");
        }
    }

    function showRef(addr) {
        const fullLink = window.location.origin + window.location.pathname + "?ref=" + addr;
        document.getElementById('linkText').innerText = fullLink;
        document.getElementById('refBox').style.display = "block";
    }

    function copyLink() {
        const text = document.getElementById('linkText').innerText;
        navigator.clipboard.writeText(text).then(() => alert("Скопировано!"));
    }
</script>

</body>
</html>
