<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>SparkPoint</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.7.0/dist/ethers.umd.min.js"></script>
    <style>
        body { background: #000; color: #fff; font-family: sans-serif; text-align: center; padding: 50px 20px; }
        .box { border: 1px solid #333; padding: 30px; border-radius: 20px; background: #111; max-width: 400px; margin: auto; }
        button { background: #f39c12; color: #000; border: none; padding: 15px; width: 100%; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 16px; margin-top: 10px; }
        #status { margin-top: 20px; color: #aaa; font-size: 14px; word-break: break-all; }
        #refBox { display: none; margin-top: 20px; background: #222; padding: 15px; border-radius: 10px; word-break: break-all; border: 1px dashed #f39c12; }
    </style>
</head>
<body>

<div class="box">
    <h1>SparkPoint</h1>
    <p>Вход: 0.05 BNB</p>
    <button id="btn" onclick="connect()">Подключить кошелек</button>
    <div id="status">Нажмите кнопку</div>
    
    <div id="refBox">
        <p style="color: #f39c12; margin: 0 0 10px 0;">Ваша ссылка для приглашения:</p>
        <small id="linkText" style="color: #2ecc71;"></small>
        <button onclick="copyLink()" style="font-size: 12px; padding: 5px; margin-top: 10px; background: #555; color: #fff;">Копировать</button>
    </div>
</div>

<script>
    const contractAddr = "0x137cbBBb38962ABd3A3a0D212C1f408FBD92ffb8";
    const bscChainId = "0x38"; // Hex для 56 (BNB Smart Chain Mainnet)

    const abi = [
        "function register(address _ref) external payable",
        "function users(address) view returns (uint256, address, uint256, uint256, uint256, bool)"
    ];

    let signer, contract;
    const refFromUrl = new URLSearchParams(window.location.search).get('ref') || "0x0000000000000000000000000000000000000000";

    async function switchNetwork() {
        try {
            await window.ethereum.request({
                method: 'wallet_switchEthereumChain',
                params: [{ chainId: bscChainId }],
            });
        } catch (error) {
            if (error.code === 4902) {
                await window.ethereum.request({
                    method: 'wallet_addEthereumChain',
                    params: [{
                        chainId: bscChainId,
                        chainName: 'BNB Smart Chain',
                        nativeCurrency: { name: 'BNB', symbol: 'BNB', decimals: 18 },
                        rpcUrls: ['https://bsc-dataseed.binance.org/'],
                        blockExplorerUrls: ['https://bscscan.com/']
                    }]
                });
            }
        }
    }

    async function connect() {
        if (!window.ethereum) {
            alert("Используйте Trust Wallet или MetaMask");
            return;
        }

        try {
            await switchNetwork(); // Сначала переключаем сеть

            const provider = new ethers.BrowserProvider(window.ethereum);
            const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
            signer = await provider.getSigner();
            contract = new ethers.Contract(contractAddr, abi, signer);
            
            const userAddr = accounts[0];
            document.getElementById('status').innerText = "Подключено: " + userAddr.substring(0,6) + "...";
            
            // Проверяем статус в контракте
            const user = await contract.users(userAddr);
            const exists = user[5]; 

            if (exists) {
                showRef(userAddr);
            } else {
                document.getElementById('btn').innerText = "Оплатить 0.05 BNB";
                document.getElementById('btn').onclick = register;
            }
        } catch (e) {
            console.error(e);
            document.getElementById('status').innerText = "Ошибка: Убедитесь, что выбрана сеть BNB Smart Chain";
        }
    }

    async function register() {
        try {
            document.getElementById('status').innerText = "Ожидание подтверждения в кошельке...";
            const tx = await contract.register(refFromUrl, {
                value: ethers.parseEther("0.05")
            });
            document.getElementById('status').innerText = "Транзакция отправлена...";
            await tx.wait();
            location.reload();
        } catch (e) {
            alert("Ошибка оплаты. Проверьте баланс (нужно 0.05 BNB + комиссия)");
            document.getElementById('status').innerText = "Оплата не прошла";
        }
    }

    function showRef(addr) {
        const link = window.location.origin + window.location.pathname + "?ref=" + addr;
        document.getElementById('linkText').innerText = link;
        document.getElementById('refBox').style.display = "block";
        document.getElementById('btn').innerText = "Вы уже участвуете";
        document.getElementById('btn').onclick = null;
        document.getElementById('btn').style.opacity = "0.5";
    }

    function copyLink() {
        const text = document.getElementById('linkText').innerText;
        navigator.clipboard.writeText(text).then(() => alert("Ссылка скопирована!"));
    }
</script>

</body>
</html>
